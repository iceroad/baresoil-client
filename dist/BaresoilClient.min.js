(function(){/*
 BaresoilClient JS
 Apache License 2.0
 Copyright (c) 2015-17 Iceroad LLC <contact@iceroad.io>
*/
function e(a){var b={serverUrl:"object"==typeof window?window.location.origin+"/__bs__/live":void 0,connectPolicy:"auto"};a=a||{};if("object"!=typeof a)throw Error("options must be provided as an object.");for(var d in b)d in a||(a[d]=b[d]);if(!a.serverUrl)throw Error('"serverUrl" must be specified in options.');if("string"!=typeof a.serverUrl||!a.serverUrl.match(/^https{0,1}:\/\//i)&&!a.serverUrl.match(/^wss{0,1}:\/\//i))throw Error('Invalid "serverUrl" parameter: '+a.serverUrl);if("auto"!==a.connectPolicy&&
"immediate"!==a.connectPolicy)throw Error('Invalid "connect" parameter: '+a.connectPolicy);this.u=a.sessionRequest;this.D=a.serverUrl;this.v=a.connectPolicy;this.a={};this.i={};this.w=1;this.f=0;this.o=[];this.g="init";this.F={init:{offline:this.l,connecting:this.j},offline:{connecting:this.j.bind(this)},connecting:{setup:this.B.bind(this),error:this.m.bind(this),offline:this.l.bind(this)},setup:{connected:this.A,error:this.m.bind(this),offline:this.l.bind(this)},connected:{connecting:this.j.bind(this),
offline:this.l.bind(this),error:this.m.bind(this)},error:{error:this.m.bind(this),connecting:this.j.bind(this),offline:this.l.bind(this)}};"immediate"===this.v?h(this,"connecting"):h(this,"offline")}function h(a,b,d){setTimeout(function(){var a=this.g;this.g=b;if(a!==b){var g=this.F[a][b];if(!g)throw Error("Cannot transition from "+a+" to "+b);g.call(this);this.h("connection_status",b,d,void 0)}}.bind(a),0)}e.prototype.connect=function(){"offline"!==this.g&&"init"!==this.g||h(this,"connecting")};
e.prototype.getConnectionStatus=function(){return this.g};e.prototype.l=function(){};
e.prototype.j=function(){var a;try{this.c&&this.c.close();var b=this.D.replace(/^http/i,"ws");a=this.c=new WebSocket(b);a.removeListener=a.removeListener||a.removeEventListener}catch(f){this.b=new e.NoWebsocketSupportError(f);h(this,"error",this.b);return}var d,c,g=!1;d=function(){g||(this.f=p(this.f),this.C=setTimeout(function(){a.removeListener("open",c);a.removeListener("error",d);this.j.call(this)}.bind(this),this.f))}.bind(this);c=function(){g||(delete this.C,delete this.b,this.f=0,a.removeListener("open",
c),a.removeListener("error",d),h(this,"setup"),g=!0)}.bind(this);a.addEventListener("open",c);a.addEventListener("error",d)};
e.prototype.B=function(){var a,b,d,c=this.c;b=function(g){if(!d)try{var f=JSON.parse(g.data),l=f[0];this.h("incoming_message",f);if("session_response"===l)f[1]&&(this.u=f[1]),d=!0,c.removeListener("message",b),c.removeListener("close",a),h(this,"connected");else if("end_connection"===l||"error"===l)this.b=f[1],h(this,"error",this.b);else if("user_event"===l)this.h.apply(this,f);else throw Error("Unknown command: "+l);}catch(k){this.b=k,h(this,"error",k),d=!0,c.removeListener("message",b),c.removeListener("close",
a)}}.bind(this);a=function(g){if(!d){var f=r[g.code]||"internal_error";this.b=new e.ConnectionTerminatedError(f,g.reason,0);c.removeListener("message",b);c.removeListener("close",a);"retry_later"===f?(this.f=p(this.f),h(this,"connecting")):h(this,"error",this.b);d=!0}}.bind(this);c.addEventListener("close",a.bind(this));c.addEventListener("message",b.bind(this));this.s(["session_request",this.u||null])};
e.prototype.A=function(){var a,b,d,c,g=this.c;b=function(f){if(!d)try{var k=JSON.parse(f.data),m=k[0];if("rpc_response"===m){var n=k[1],t=n.requestId,u=this.i[t];if(u){delete this.i[t];var q;"object"===typeof n.error&&(q=Error(),q.message=n.error.message);u.call(this,q,n.result)}this.h.apply(this,k)}else if("user_event"===m)this.h.apply(this,k);else if("end_connection"===m)c=k[1],this.h.apply(this,k);else throw Error("Unknown command from server: "+m);}catch(v){console.error("BaresoilClient: invalid packet from server during session:",
f.data,v),this.b=v,h(this,"error",this.b),d=!0,g.removeListener("message",b),g.removeListener("close",a)}}.bind(this);a=function(f){if(!d){var k=r[f.code]||"internal_error";this.b=new e.ConnectionTerminatedError(k,c?c.message:f.reason,c?c.G:0);g.removeListener("message",b);g.removeListener("close",a);"retry_later"===k?(this.f=p(this.f),h(this,"connecting")):h(this,"error",this.b);d=!0}}.bind(this);g.addEventListener("close",a.bind(this));g.addEventListener("message",b.bind(this));var f=this.o;f.length&&
(f.forEach(this.s.bind(this)),f.splice(0,f.length))};e.prototype.m=function(){this.c&&(this.c.close(),delete this.c);var a=this.b;this.b=a;for(var b in this.i)(0,this.i[b])(a||Error("BaresoilClient: client state reset."));this.i={};this.g="error";this.o=[];this.f=0};
var r={1E3:"close_normal",1001:"retry_later",1002:"protocol_error",1003:"protocol_error",1005:"retry_later",1006:"retry_later",1007:"protocol_error",1008:"policy_violation",1009:"policy_violation",1010:"protocol_error",1011:"internal_error",1012:"retry_later",1013:"retry_later"};
e.prototype.run=function(a,b,d){if(!a||"string"!=typeof a||256<a.length)throw Error("Handler function name must be a string <= 256 chars.");if(!d||"function"!=typeof d)if("function"==typeof b)d=b,b=void 0;else throw Error("Last parameter must be a callback function.");var c=this.g;if("error"===c)return d(Error("BaresoilClient.run() cannot be called while in an error state."));if("init"===c||"connecting"===c||"setup"===c||"offline"===c||"connected"===c){var g=this.w++;this.i[g]=d;a=["rpc_request",
{requestId:g,"function":a,arguments:b}];"connected"===c?this.s(a):this.o.push(a)}"offline"!==c&&"init"!==c||"auto"!==this.v||this.connect()};e.prototype.close=function(){this.c&&(this.c.removeAllListeners(),this.c.close(),delete this.c);h(this,"offline")};e.prototype.on=function(a,b){this.a[a]=this.a[a]||[];this.a[a].push([b,!0]);return b};e.prototype.once=function(a,b){this.a[a]=this.a[a]||[];this.a[a].push([b,!1]);return b};
e.prototype.removeEventListener=function(a,b){if("function"!==typeof b)throw Error("removeEventListener() must be called with a function reference.");this.a[a]&&(this.a[a]=this.a[a].filter(function(a){return a!==b}))};e.prototype.removeAllListeners=function(a){a?delete this.a[a]:this.a={}};e.prototype.getConnectionStatus=function(){return this.g};e.prototype.getError=function(){return this.b};e.prototype.setSessionRequest=function(a){this.u=a};
e.prototype.h=function(){var a=Array.prototype.slice.call(arguments);if(1>a.length)throw Error("emit() requires at least one argument.");var b=a[0],d=a.slice(1),c=[];this.a[b]&&(this.a[b]=this.a[b].filter(function(a){c.push([a[0],d]);return a[1]}));this.a["*"]&&(this.a["*"]=this.a["*"].filter(function(b){c.push([b[0],a]);return b[1]}));c.forEach(function(a){a[0].apply(this,a[1])})};e.prototype.s=function(a){this.h("outgoing_message",a);this.c.send(JSON.stringify(a))};
function p(a){a=Math.min(3E5,Math.max(1E3,a));a*=1.2;return Math.floor(Math.min(3E5,Math.max(1E3,a+(.2*Math.random()*a-.1))))}e.NoWebsocketSupportError=function(a){this.code="no_websocket_support";this.message=a.message||"No Websocket support found.";this.retryAfter=0};e.NoWebsocketSupportError.prototype=Error();e.ConnectionTerminatedError=function(a,b,d){this.code=a;this.message=b;this.retryAfter=d};e.ConnectionTerminatedError.prototype=Error();
"object"===typeof module?module.exports=e:window.BaresoilClient=e;})();
