(function(){/*
 BaresoilClient JS
 Apache License 2.0
 Copyright (c) 2015-17 Iceroad LLC <contact@iceroad.io>
*/
function d(a){var b={endpoint:"object"==typeof window?window.location.origin+"/__bs__/live":void 0,connectPolicy:"auto",failFast:!1};a=a||{};if("object"!=typeof a)throw Error("options must be provided as an object.");for(var c in b)c in a||(a[c]=b[c]);if(!a.endpoint){if(!a.server)throw Error('"options.server" must be specified if "options.endpoint" is not.');if(!a.server)throw Error('"options.server" must be specified if "options.endpoint" is not.');a.endpoint=a.server.replace(/\/+$/g,"")+"/__bs__/live"}if("string"!=
typeof a.endpoint||!a.endpoint.match(/^https{0,1}:\/\//i)&&!a.endpoint.match(/^wss{0,1}:\/\//i))throw Error('Invalid "endpoint" parameter: '+a.endpoint);if("auto"!==a.connectPolicy&&"manual"!==a.connectPolicy&&"immediate"!==a.connectPolicy)throw Error('Invalid "connect" parameter: '+a.connectPolicy);this.j=a.sessionRequest;this.m=a.endpoint;this.l=a.connectPolicy;this.s=a.failFast;this.reset();"immediate"===this.l?this.connect():this.w("connection_status","offline")}
d.prototype.reset=function(){this.a={};this.f={};this.B=1;this.i=0;this.v=[];this.c="offline";this.o=[];f(this);g(this)};function g(a){for(var b in a.f){var c=a.f[b];delete a.f[b];var e=Error("Connection to server was dropped.");e.code="connection_dropped";c(e)}}function f(a){var b=a.h;if(b){a.o.forEach(function(a){b.removeEventListener(a[0],a[1])});try{b.close()}catch(c){}}delete a.h;a.o=[]}
function k(a,b,c){a.c=b;a.g=c;b!==a.A&&(a.b("connection_status",b),"connected"===b&&a.b("connected"),a.A=b);c&&(g(a),f(a),a.b("error",c))}
d.prototype.connect=function(){if("offline"!==this.c)console.warn("Ignoring connect() call in state:",this.c);else return setTimeout(function(){f(this);k(this,"connecting");var a,b;try{b=this.m.replace(/^http/i,"ws");var c=this.h=new WebSocket(b);c.removeListener=c.removeListener||c.removeEventListener;this.h=a=c}catch(e){return a=new d.NoWebsocketSupportError(e),k(this,"error",a)}c=this.o;b=this.D.bind(this);c.push(["error",b]);a.addEventListener("error",b);b=this.F.bind(this);c.push(["message",
b]);a.addEventListener("message",b);b=this.C.bind(this);c.push(["close",b]);a.addEventListener("close",b);b=this.G.bind(this);c.push(["open",b]);a.addEventListener("open",b)}.bind(this),10)};d.prototype.G=function(){k(this,"setup");l(this,["session_request",{userData:this.j}])};
d.prototype.C=function(a){var b=m[a.code]||"internal_error";g(this);if("retry_later"===b)f(this),this.c="offline",this.connect();else{if("close_normal"===b)return f(this),k(this,"offline");this.g=new d.ConnectionTerminatedError(b,a.reason,a);return k(this,"error",this.g)}};
d.prototype.F=function(a){this.b("incoming_message_raw",a.data);try{var b=JSON.parse(a.data),c=b[0];this.b("incoming_message",b)}catch(n){return this.b("protocol_error",n)}if("session_response"===c){b=b[1];if(b.auth){this.H=b.userData||{};for(var b=this.v,e=0;e<b.length;e++)this.u.apply(this,b[e]);return k(this,"connected")}this.g=Error(b.error?b.error.message:"Session refused by server.");return k(this,"error",this.g)}if("user_event"===c)this.b.apply(this,[b[0],b[1].name,b[1].data]);else if("rpc_response"===
c){a=b[1];var c=a.requestId,h=this.f[c];h&&(delete this.f[c],"object"===typeof a.error&&(e=Error(),e.message=a.error.message,e.code=a.error.code),h.call(this,e,a.result));this.b.apply(this,b)}else return this.b("protocol_error","Unknown message from server: "+a.data)};d.prototype.D=function(a){if(this.s)return k(this,"error",a);this.i=p(this.i);this.b("reconnecting",this.i);f(this);setTimeout(function(){this.c="offline";this.connect()}.bind(this),this.i)};d.prototype.close=function(){try{this.h.close()}catch(a){}};
d.prototype.run=function(a,b,c){if(!a||"string"!=typeof a||256<a.length)throw Error("Handler function name must be a string <= 256 chars.");if(!c||"function"!=typeof c)if("function"==typeof b)c=b,b=void 0;else throw Error("Last parameter must be a callback function.");var e=this.c;if("error"===e)return c(Error("BaresoilClient.run() cannot be called while in an error state."));if("connected"===e)return this.u(a,b,c);"offline"!==e&&"setup"!==e&&"connecting"!==e||this.v.push([a,b,c]);"offline"===e&&
"auto"===this.l&&this.connect()};d.prototype.u=function(a,b,c){var e=this.B++;a=["rpc_request",{requestId:e,"function":a,argument:b}];try{l(this,a)}catch(h){return c(h)}this.f[e]=c};d.prototype.getConnectionStatus=function(){return this.c};d.prototype.setConfigParameter=function(a,b){if("failFast"===a)return this.s=b;if("endpoint"===a)return this.m=b;if("sessionRequest"===a)return this.j=b;if("connectPolicy"===a)return this.l=b};
var m={1E3:"close_normal",1001:"retry_later",1002:"protocol_error",1003:"protocol_error",1005:"retry_later",1006:"retry_later",1007:"protocol_error",1008:"policy_violation",1009:"policy_violation",1010:"protocol_error",1011:"internal_error",1012:"retry_later",1013:"retry_later"};d.prototype.on=function(a,b){this.a[a]=this.a[a]||[];this.a[a].push([b,!0]);return b};d.prototype.once=function(a,b){this.a[a]=this.a[a]||[];this.a[a].push([b,!1]);return b};
d.prototype.removeEventListener=function(a,b){if("function"!==typeof b)throw Error("removeEventListener() must be called with a function reference.");this.a[a]&&(this.a[a]=this.a[a].filter(function(a){return a!==b}))};d.prototype.removeAllListeners=function(a){a?delete this.a[a]:this.a={}};d.prototype.getError=function(){return this.g};d.prototype.getEndpoint=function(){return this.m};d.prototype.getSessionRequest=function(){return this.j};d.prototype.setSessionRequest=function(a){this.j=a};
d.prototype.getSessionResponse=function(){return this.H};d.prototype.b=function(){var a=Array.prototype.slice.call(arguments);if(1>a.length)throw Error("emit() requires at least one argument.");var b=a[0],c=a.slice(1),e=[];this.a[b]&&(this.a[b]=this.a[b].filter(function(a){e.push([a[0],c]);return a[1]}));this.a["*"]&&(this.a["*"]=this.a["*"].filter(function(b){e.push([b[0],a]);return b[1]}));var h=this;e.forEach(function(a){a[0].apply(h,a[1])})};
d.prototype.w=function(){var a=Array.prototype.slice.call(arguments),b=this;setTimeout(function(){b.b.apply(b,a)},0)};function l(a,b){a.b("outgoing_message",b);var c=JSON.stringify(b);a.b("outgoing_message_raw",c);a.h.send(c)}function p(a){a=Math.min(18E5,Math.max(1E3,a));a*=1.2;return Math.floor(Math.min(18E5,Math.max(1E3,a+(.2*Math.random()*a-.1))))}d.NoWebsocketSupportError=function(a){this.code="no_websocket_support";this.message=a.message||"No Websocket support found.";this.retryAfter=0};
d.NoWebsocketSupportError.prototype=Error();d.ConnectionTerminatedError=function(a,b,c){this.code=a;this.message=b;this.wsCloseEvt=c};d.ConnectionTerminatedError.prototype=Error();"object"===typeof module?module.exports=d:window.BaresoilClient=d;})();
