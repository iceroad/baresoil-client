(function(){/*
 BaresoilClient JS
 Apache License 2.0
 Copyright (c) 2015-17 Iceroad LLC <contact@iceroad.io>
*/
function e(a){var b={serverUrl:"object"==typeof window?window.location.origin+"/__bs__/live":void 0,connectPolicy:"auto"};a=a||{};if("object"!=typeof a)throw Error("options must be provided as an object.");for(var c in b)c in a||(a[c]=b[c]);if(!a.serverUrl)throw Error('"serverUrl" must be specified in options.');if("string"!=typeof a.serverUrl||!a.serverUrl.match(/^https{0,1}:\/\//i)&&!a.serverUrl.match(/^wss{0,1}:\/\//i))throw Error('Invalid "serverUrl" parameter: '+a.serverUrl);if("auto"!==a.connectPolicy&&
"immediate"!==a.connectPolicy)throw Error('Invalid "connect" parameter: '+a.connectPolicy);this.u=a.sessionRequest;this.F=a.serverUrl;this.v=a.connectPolicy;this.a={};this.i={};this.w=1;this.f=0;this.o=[];this.g="init";this.G={init:{offline:this.m,connecting:this.j},offline:{connecting:this.j.bind(this)},connecting:{setup:this.B.bind(this),error:this.l.bind(this)},setup:{connected:this.A,error:this.l.bind(this),offline:this.m.bind(this)},connected:{connecting:this.j.bind(this),offline:this.m.bind(this),
error:this.l.bind(this)},error:{connecting:this.j.bind(this)}};"immediate"===this.v?k(this,"connecting"):k(this,"offline")}function k(a,b,c){setTimeout(function(){var a=this.g;this.g=b;var f=this.G[a][b];if(!f)throw Error("Cannot transition from "+a+" to "+b);f.call(this);this.h("connection_status",b,c)}.bind(a),0)}e.prototype.connect=function(){"offline"!==this.g&&"init"!==this.g||k(this,"connecting")};e.prototype.getConnectionStatus=function(){return this.g};e.prototype.m=function(){};
e.prototype.j=function(){var a;try{this.b&&this.b.close();var b=this.F.replace(/^http/i,"ws");a=this.b=new WebSocket(b);a.removeListener=a.removeListener||a.removeEventListener}catch(g){this.c=new e.NoWebsocketSupportError(g);k(this,"error");return}var c,d,f=!1;c=function(){f||(this.f=n(this.f),this.D=setTimeout(function(){a.removeListener("open",d);a.removeListener("error",c);this.j.call(this)}.bind(this),this.f))}.bind(this);d=function(){f||(delete this.D,delete this.c,this.f=0,a.removeListener("open",
d),a.removeListener("error",c),k(this,"setup"),f=!0)}.bind(this);a.addEventListener("open",d);a.addEventListener("error",c)};
e.prototype.B=function(){var a,b,c,d,f=this.b;b=function(g){if(!c)try{var l=JSON.parse(g.data),h=l[0];this.h("incoming_message",l);if("session_response"===h)l[1]&&(this.u=l[1]),c=!0,f.removeListener("message",b),f.removeListener("close",a),k(this,"connected");else if("end_connection"===h||"error"===h)this.c=l[1],d=l[2],k(this,"error");else if("user_event"===h){var q=l[1];this.h.call(this,q.name,q.data)}else throw Error("Unknown command: "+h);}catch(m){this.c=m,k(this,"error"),c=!0,f.removeListener("message",
b),f.removeListener("close",a)}}.bind(this);a=function(g){if(!c){var l=r[g.code]||"internal_error";this.c=new e.ConnectionTerminatedError(l,d?d.message:g.reason,d?d.C:0);f.removeListener("message",b);f.removeListener("close",a);"retry_later"===l?(this.f=n(this.f),k(this,"connecting")):k(this,"error",this.c);c=!0}}.bind(this);f.addEventListener("close",a.bind(this));f.addEventListener("message",b.bind(this));this.s(["session_request",this.u||null])};
e.prototype.A=function(){var a,b,c,d,f=this.b;b=function(l){if(!c)try{var h=JSON.parse(l.data),g=h[0];if("rpc_response"===g){var m=h[1],t=m.requestId,u=this.i[t];if(u){delete this.i[t];var p;"object"===typeof m.error&&(p=Error(),p.message=m.error.message);u.call(this,p,m.result)}this.h.apply(this,h)}else if("user_event"===g){var v=h[1];this.h.call(this,v.name,v.data)}else if("end_connection"===g)d=h[1],this.h.apply(this,h);else throw Error("Unknown command from server: "+g);}catch(w){console.error("BaresoilClient: invalid packet from server during session:",
l.data,w),this.c=w,k(this,"error"),c=!0,f.removeListener("message",b),f.removeListener("close",a)}}.bind(this);a=function(g){if(!c){var h=r[g.code]||"internal_error";this.c=new e.ConnectionTerminatedError(h,d?d.message:g.reason,d?d.C:0);f.removeListener("message",b);f.removeListener("close",a);"retry_later"===h?(this.f=n(this.f),k(this,"connecting")):k(this,"error",this.c);c=!0}}.bind(this);f.addEventListener("close",a.bind(this));f.addEventListener("message",b.bind(this));var g=this.o;g.length&&
(g.forEach(this.s.bind(this)),g.splice(0,g.length))};e.prototype.l=function(){this.b&&(this.b.close(),delete this.b);var a=this.c;this.c=a;for(var b in this.i)(0,this.i[b])(a||Error("BaresoilClient: client state reset."));this.i={};this.g="error";this.o=[];this.f=0};
var r={1E3:"close_normal",1001:"retry_later",1002:"protocol_error",1003:"protocol_error",1005:"retry_later",1006:"retry_later",1007:"protocol_error",1008:"policy_violation",1009:"policy_violation",1010:"protocol_error",1011:"internal_error",1012:"retry_later",1013:"retry_later"};
e.prototype.run=function(a,b,c){if(!a||"string"!=typeof a||256<a.length)throw Error("Handler function name must be a string <= 256 chars.");if(!c||"function"!=typeof c)if("function"==typeof b)c=b,b=void 0;else throw Error("Last parameter must be a callback function.");var d=this.g;if("error"===d)return c(Error("BaresoilClient.run() cannot be called while in an error state."));if("init"===d||"connecting"===d||"setup"===d||"offline"===d||"connected"===d){var f=this.w++;this.i[f]=c;a=["rpc_request",
{requestId:f,"function":a,arguments:b}];"connected"===d?this.s(a):this.o.push(a)}"offline"!==d&&"init"!==d||"auto"!==this.v||this.connect()};e.prototype.close=function(){this.b&&(this.b.removeAllListeners(),this.b.close(),delete this.b);k(this,"offline")};e.prototype.on=function(a,b){this.a[a]=this.a[a]||[];this.a[a].push([b,!0]);return b};e.prototype.once=function(a,b){this.a[a]=this.a[a]||[];this.a[a].push([b,!1]);return b};
e.prototype.removeEventListener=function(a,b){if("function"!==typeof b)throw Error("removeEventListener() must be called with a function reference.");this.a[a]&&(this.a[a]=this.a[a].filter(function(a){return a!==b}))};e.prototype.removeAllListeners=function(a){a?delete this.a[a]:this.a={}};e.prototype.getConnectionStatus=function(){return this.g};e.prototype.getError=function(){return this.c};e.prototype.setSessionRequest=function(a){this.u=a};
e.prototype.h=function(){var a=Array.prototype.slice.call(arguments);if(1>a.length)throw Error("emit() requires at least one argument.");var b=a[0],c=a.slice(1),d=[];this.a[b]&&(this.a[b]=this.a[b].filter(function(a){d.push([a[0],c]);return a[1]}));this.a["*"]&&(this.a["*"]=this.a["*"].filter(function(b){d.push([b[0],a]);return b[1]}));d.forEach(function(a){a[0].apply(this,a[1])})};e.prototype.s=function(a){this.h("outgoing_message",a);this.b.send(JSON.stringify(a))};
function n(a){a=Math.min(3E5,Math.max(1E3,a));a*=1.2;return Math.floor(Math.min(3E5,Math.max(1E3,a+(.2*Math.random()*a-.1))))}e.NoWebsocketSupportError=function(a){this.code="no_websocket_support";this.message=a.message||"No Websocket support found.";this.retryAfter=0};e.NoWebsocketSupportError.prototype=Error();e.ConnectionTerminatedError=function(a,b,c){this.code=a;this.message=b;this.retryAfter=c};e.ConnectionTerminatedError.prototype=Error();
"object"===typeof module?module.exports=e:window.BaresoilClient=e;})();
