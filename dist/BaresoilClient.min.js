(function(){/*
 BaresoilClient JS
 Apache License 2.0
 Copyright (c) 2015-17 Iceroad LLC <contact@iceroad.io>
*/
function d(a){var b={serverUrl:"object"==typeof window?window.location.origin+"/__bs__/live":void 0,connectPolicy:"auto"};a=a||{};if("object"!=typeof a)throw Error("options must be provided as an object.");for(var c in b)c in a||(a[c]=b[c]);if(!a.serverUrl)throw Error('"serverUrl" must be specified in options.');if("string"!=typeof a.serverUrl||!a.serverUrl.match(/^https{0,1}:\/\//i)&&!a.serverUrl.match(/^wss{0,1}:\/\//i))throw Error('Invalid "serverUrl" parameter: '+a.serverUrl);if("auto"!==a.connectPolicy&&
"immediate"!==a.connectPolicy)throw Error('Invalid "connect" parameter: '+a.connectPolicy);this.v=a.sessionRequest;this.F=a.serverUrl;this.s=a.connectPolicy;this.a={};this.h={};this.w=1;this.f=0;this.m=[];this.g="init";this.G={init:{offline:this.u,connecting:this.j},offline:{connecting:this.j.bind(this)},connecting:{setup:this.B.bind(this),error:this.l.bind(this)},setup:{connected:this.A,error:this.l.bind(this)},connected:{connecting:this.j.bind(this),offline:this.u.bind(this),error:this.l.bind(this)},
error:{connecting:this.j.bind(this)}};"immediate"===this.s?k(this,"connecting"):k(this,"offline")}function k(a,b,c){setTimeout(function(){var a=this.g;this.g=b;var f=this.G[a][b];if(!f)throw Error("Cannot transition from "+a+" to "+b);f.call(this);this.i("connection_status",b,c)}.bind(a),0)}d.prototype.connect=function(){"offline"!==this.g&&"init"!==this.g||k(this,"connecting")};d.prototype.getConnectionStatus=function(){return this.g};d.prototype.u=function(){};
d.prototype.j=function(){var a;try{this.c&&this.c.close();var b=this.F.replace(/^http/i,"ws");a=this.c=new WebSocket(b);a.removeListener=a.removeListener||a.removeEventListener}catch(g){this.b=new d.NoWebsocketSupportError(g);k(this,"error");return}var c,e,f=!1;c=function(){f||(this.f=n(this.f),this.D=setTimeout(function(){a.removeListener("open",e);a.removeListener("error",c);this.j.call(this)}.bind(this),this.f))}.bind(this);e=function(){f||(delete this.D,delete this.b,this.f=0,a.removeListener("open",
e),a.removeListener("error",c),k(this,"setup"),f=!0)}.bind(this);a.addEventListener("open",e);a.addEventListener("error",c)};
d.prototype.B=function(){var a,b,c,e,f=this.c;b=function(g){if(!c)try{var h=JSON.parse(g.data),l=h[0];if("session_response"===l)h[1][0]?(this.b=h[1][0],k(this,"error")):(1<h[1].length&&(this.v=h[1][1]),c=!0,f.removeListener("message",b),f.removeListener("close",a),k(this,"connected"));else if("end_connection"===l)this.b=h[1],e=h[2],k(this,"error");else if("user_event"===l){var q=h[1];this.i.call(this,q.name,q.data)}else throw Error("Unknown command: "+l);}catch(m){this.b=m,k(this,"error"),c=!0,f.removeListener("message",
b),f.removeListener("close",a)}}.bind(this);a=function(g){if(!c){var h=r[g.code]||"internal_error";this.b=new d.ConnectionTerminatedError(h,e?e.message:g.reason,e?e.C:0);f.removeListener("message",b);f.removeListener("close",a);"retry_later"===h?(this.f=n(this.f),k(this,"connecting")):k(this,"error",this.b);c=!0}}.bind(this);f.addEventListener("close",a.bind(this));f.addEventListener("message",b.bind(this));this.o(["session_request",this.v||null])};
d.prototype.A=function(){var a,b,c,e,f=this.c;b=function(h){if(!c)try{var l=JSON.parse(h.data),g=l[0];if("rpc_response"===g){var m=l[1],t=m.requestId,u=this.h[t];if(u){delete this.h[t];var p;"object"===typeof m.error&&(p=Error(),p.message=m.error.message);u.call(this,p,m.result)}this.i.apply(this,l)}else if("user_event"===g){var v=l[1];this.i.call(this,v.name,v.data)}else if("end_connection"===g)e=l[1],this.i.apply(this,l);else throw Error("Unknown command from server: "+g);}catch(w){console.error("BaresoilClient: invalid packet from server during session:",
h.data,w),this.b=w,k(this,"error"),c=!0,f.removeListener("message",b),f.removeListener("close",a)}}.bind(this);a=function(h){if(!c){var g=r[h.code]||"internal_error";this.b=new d.ConnectionTerminatedError(g,e?e.message:h.reason,e?e.C:0);f.removeListener("message",b);f.removeListener("close",a);"retry_later"===g?(this.f=n(this.f),k(this,"connecting")):k(this,"error",this.b);c=!0}}.bind(this);f.addEventListener("close",a.bind(this));f.addEventListener("message",b.bind(this));var g=this.m;g.length&&
(g.forEach(this.o.bind(this)),g.splice(0,g.length))};d.prototype.l=function(){this.c&&(this.c.close(),delete this.c);var a=this.b;this.b=a;for(var b in this.h)(0,this.h[b])(a||Error("BaresoilClient: client state reset."));this.h={};this.g="error";this.m=[];this.f=0};
var r={1E3:"close_normal",1001:"retry_later",1002:"protocol_error",1003:"protocol_error",1005:"retry_later",1006:"retry_later",1007:"protocol_error",1008:"policy_violation",1009:"policy_violation",1010:"protocol_error",1011:"internal_error",1012:"retry_later",1013:"retry_later"};
d.prototype.run=function(a,b,c){if(!a||"string"!=typeof a||256<a.length)throw Error("Handler function name must be a string <= 256 chars.");if(!c||"function"!=typeof c)if("function"==typeof b)c=b,b=void 0;else throw Error("Last parameter must be a callback function.");var e=this.g;if("error"===e)return c(Error("BaresoilClient.run() cannot be called while in an error state."));if("init"===e||"connecting"===e||"setup"===e||"offline"===e||"connected"===e){var f=this.w++;this.h[f]=c;a=["rpc_request",
{requestId:f,"function":a,arguments:[b]}];"connected"===e?this.o(a):this.m.push(a)}"offline"!==e&&"init"!==e||"auto"!==this.s||this.connect()};d.prototype.close=function(){this.c&&(this.c.removeAllListeners(),this.c.close(),delete this.c);k(this,"offline")};d.prototype.on=function(a,b){this.a[a]=this.a[a]||[];this.a[a].push([b,!0]);return b};d.prototype.once=function(a,b){this.a[a]=this.a[a]||[];this.a[a].push([b,!1]);return b};
d.prototype.removeEventListener=function(a,b){if("function"!==typeof b)throw Error("removeEventListener() must be called with a function reference.");this.a[a]&&(this.a[a]=this.a[a].filter(function(a){return a!==b}))};d.prototype.removeAllListeners=function(a){a?delete this.a[a]:this.a={}};d.prototype.getConnectionStatus=function(){return this.g};d.prototype.getError=function(){return this.b};
d.prototype.i=function(){var a=Array.prototype.slice.call(arguments);if(1>a.length)throw Error("emit() requires at least one argument.");var b=a[0];a.splice(0,1);var c=[];this.a[b]&&(this.a[b]=this.a[b].filter(function(a){c.push(a);return a[1]}));this.a["*"]&&(this.a["*"]=this.a["*"].filter(function(a){c.push(a);return a[1]}));this.a[b]||delete this.a[b];this.a["*"]||delete this.a["*"];c.forEach(function(b){b[0].apply(this,a)})};d.prototype.o=function(a){this.c.send(JSON.stringify(a))};
function n(a){a=Math.min(3E5,Math.max(1E3,a));a*=1.2;return Math.floor(Math.min(3E5,Math.max(1E3,a+(.2*Math.random()*a-.1))))}d.NoWebsocketSupportError=function(a){this.code="no_websocket_support";this.message=a.message||"No Websocket support found.";this.retryAfter=0};d.NoWebsocketSupportError.prototype=Error();d.ConnectionTerminatedError=function(a,b,c){this.code=a;this.message=b;this.retryAfter=c};d.ConnectionTerminatedError.prototype=Error();
"object"==typeof module&&"function"==typeof require?(WebSocket=require("ws"),module.exports=d):window.BaresoilClient=d;})();
