(function(){/*
 BaresoilClient JS
 Apache License 2.0
 Copyright (c) 2015-16 Iceroad LLC <contact@iceroad.io>
*/
function d(a){var b={serverUrl:"object"==typeof window?window.location.origin+"/__bs__/live":void 0,connectPolicy:"auto"};a=a||{};if("object"!=typeof a)throw Error("options must be provided as an object.");for(var c in b)c in a||(a[c]=b[c]);if(!a.serverUrl)throw Error('"serverUrl" must be specified in options.');if("string"!=typeof a.serverUrl||!a.serverUrl.match(/^https{0,1}:\/\//i)&&!a.serverUrl.match(/^wss{0,1}:\/\//i))throw Error('Invalid "serverUrl" parameter: '+a.serverUrl);if("auto"!==a.connectPolicy&&
"immediate"!==a.connectPolicy&&"manual"!==a.connectPolicy)throw Error('Invalid "connect" parameter: '+a.connectPolicy);this.D={connecting:this.o.bind(this),setup:this.B.bind(this),connected:this.v.bind(this),error:this.w.bind(this),offline:this.A.bind(this)};this.sessionPacket=a.sessionPacket;this.serverUrl=a.serverUrl;this.s=a;this.h="offline";this.a={};this.g={};this.u=1;this.f=0;this.l=[];"immediate"===a.connectPolicy&&this.connect()}
var k={1E3:"close_normal",1001:"retry_later",1002:"protocol_error",1003:"protocol_error",1005:"retry_later",1006:"retry_later",1007:"protocol_error",1008:"policy_violation",1009:"policy_violation",1010:"protocol_error",1011:"internal_error",1012:"retry_later",1013:"retry_later"};d.prototype.connect=function(){"offline"===this.h&&setTimeout(function(){n(this,"connecting")}.bind(this),0)};function n(a,b,c){a.h=b;a.D[b].call(a);a.i("connection_status",b,c)}
d.prototype.o=function(){var a;try{this.c&&this.c.close();var b=this.serverUrl.replace(/^http/i,"ws");a=this.c=new WebSocket(b)}catch(f){this.b=new d.NoWebsocketSupportError(f);n(this,"error");return}var c,e,g=!1;c=function(){g||(this.f=p(this.f),this.j=setTimeout(function(){a.removeListener("open",e);a.removeListener("error",c);this.o.call(this)}.bind(this),this.f))}.bind(this);e=function(){g||(delete this.j,delete this.b,this.f=0,a.removeListener("open",e),a.removeListener("error",c),n(this,"setup"),
g=!0)}.bind(this);a.addEventListener("open",e);a.addEventListener("error",c)};
d.prototype.B=function(){var a=this.s.verbose,b,c,e,g,f=this.c;c=function(q){if(!e)try{var h=JSON.parse(q.data),l=h[0];if("session_response"===l)1<h.length&&(this.sessionPacket=h[1]),n(this,"connected"),e=!0,f.removeListener("message",c),f.removeListener("close",b);else if("end_connection"===l)this.b=h[1],g=h[2];else throw Error("Unknown command: "+l);}catch(m){console.error("BaresoilClient: invalid packet from server:",q.data),a&&console.error("BaresoilClient: error:",m),this.b=m,n(this,"error"),
e=!0,f.removeListener("message",c),f.removeListener("close",b)}}.bind(this);b=function(a){if(!e){var h=k[a.code]||"internal_error";this.b=new d.ConnectionTerminatedError(h,g?g.message:a.reason,g?g.C:0);f.removeListener("message",c);f.removeListener("close",b);"retry_later"===h?(this.f=p(this.f),n(this,"connecting")):n(this,"error",this.b);e=!0}}.bind(this);f.addEventListener("close",b.bind(this));f.addEventListener("message",c.bind(this));this.m(["session_request",this.F||null])};
d.prototype.v=function(){var a,b,c,e,g=this.c;b=function(f){if(!c)try{var h=JSON.parse(f.data),l=h[0];if("rpc_response"===l){var m=h[1],r=m.rpcId,t=this.g[r];t&&(delete this.g[r],t(m.error,m.fnResults));this.i.apply(this,h)}else if("handler_event"===l)this.i.apply(this,h);else if("end_connection"===l)e=h[1],this.i.apply(this,h);else throw Error("Unknown command from server: "+l);}catch(v){console.error("BaresoilClient: invalid packet from server:",f.data),this.b=v,n(this,"error"),c=!0,g.removeListener("message",
b),g.removeListener("close",a)}}.bind(this);a=function(f){if(!c){var h=k[f.code]||"internal_error";this.b=new d.ConnectionTerminatedError(h,e?e.message:f.reason,e?e.C:0);g.removeListener("message",b);g.removeListener("close",a);"retry_later"===h?(this.f=p(this.f),n(this,"connecting")):n(this,"error",this.b);c=!0}}.bind(this);g.addEventListener("close",a.bind(this));g.addEventListener("message",b.bind(this));var f=this.l;f.length&&(f.forEach(this.m.bind(this)),f.splice(0,f.length))};
d.prototype.w=function(){this.c&&(this.c.close(),delete this.c);u(this,this.b)};d.prototype.A=function(){this.G&&(this.c.close(),delete this.c);this.j&&(clearTimeout(this.j),delete this.j);u(this)};
d.prototype.run=function(a,b,c){if(!a||"string"!=typeof a||256<a.length)throw Error("Handler function name must be a string <= 256 chars.");if(!c||"function"!=typeof c)if("function"==typeof b)c=b,b=void 0;else throw Error("Last parameter must be a callback function.");var e=this.h;if("error"===e)return c(Error("BaresoilClient.run() cannot be called while in an error state."));if("connecting"===e||"setup"===e||"offline"===e||"reconnecting"===e||"connected"===e){var g=this.u++;this.g[g]=c;a=["rpc_request",
{rpcId:g,fnName:a,fnArgs:b}];"connected"===e?this.m(a):this.l.push(a)}"offline"===e&&"auto"===this.s.connectPolicy&&this.connect()};d.prototype.close=function(){n(this,"offline")};d.prototype.on=function(a,b){this.a[a]=this.a[a]||[];this.a[a].push([b,!0]);return b};d.prototype.once=function(a,b){this.a[a]=this.a[a]||[];this.a[a].push([b,!1]);return b};
d.prototype.removeEventListener=function(a,b){if("function"!==typeof b)throw Error("removeEventListener() must be called with a function reference.");this.a[a]&&(this.a[a]=this.a[a].filter(function(a){return a!==b}))};d.prototype.removeAllListeners=function(a){a?delete this.a[a]:this.a={}};d.prototype.getConnectionStatus=function(){return this.h};d.prototype.getError=function(){return this.b};
d.prototype.i=function(){var a=Array.prototype.slice.call(arguments);if(1>a.length)throw Error("emit() requires at least one argument.");var b=a[0];a.splice(0,1);var c=[];this.a[b]&&(this.a[b]=this.a[b].filter(function(a){c.push(a);return a[1]}));this.a["*"]&&(this.a["*"]=this.a["*"].filter(function(a){c.push(a);return a[1]}));this.a[b]||delete this.a[b];this.a["*"]||delete this.a["*"];c.forEach(function(b){b[0].apply(this,a)})};d.prototype.m=function(a){this.c.send(JSON.stringify(a))};
function u(a,b){a.b=b;for(var c in a.g)(0,a.g[c])(b||Error("BaresoilClient: client state reset."));a.g={};a.h="error";a.l=[];a.f=0}function p(a){a=Math.min(3E5,Math.max(1E3,a));a*=1.2;return Math.floor(Math.min(3E5,Math.max(1E3,a+(.2*Math.random()*a-.1))))}d.NoWebsocketSupportError=function(a){this.code="no_websocket_support";this.message=a.message||"No Websocket support found.";this.retryAfter=0};d.NoWebsocketSupportError.prototype=Error();
d.ConnectionTerminatedError=function(a,b,c){this.code=a;this.message=b;this.retryAfter=c};d.ConnectionTerminatedError.prototype=Error();"object"==typeof module&&"function"==typeof require?(WebSocket=require("ws"),module.exports=d):window.BaresoilClient=d;})();
